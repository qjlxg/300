name: ğŸš€ ä¼˜åŒ–ç‰ˆæŒ‡æ•°åˆ†æ (å¢é‡ä¸é‡å )

# å®šä¹‰è§¦å‘å™¨
on:
  # 1. æ¯å¤©å®šæ—¶è¿è¡Œ (åŒ—äº¬æ—¶é—´ 18:00)
  schedule:
    # cron: '0 10 * * *' # UTCæ—¶é—´ 10:00ï¼Œå¯¹åº”åŒ—äº¬æ—¶é—´ 18:00
    - cron: '0 10 * * *'
  # 2. æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  # 3. æäº¤ä»£ç åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches:
      - main

jobs:
  analyze_and_push:
    runs-on: ubuntu-latest
    
    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4
        with:
          # å¿…é¡»æ‹‰å–å†å²è®°å½•æ‰èƒ½è¿›è¡Œ Git æäº¤
          fetch-depth: 0

      # 1. è®¾ç½® Python ç¯å¢ƒ (ä¿®å¤ numba å…¼å®¹æ€§é—®é¢˜)
      - name: ğŸ Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # 2. å®‰è£…ä¾èµ–
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          # å®‰è£… akshare, pandas, pandas-ta
          # ã€å…³é”®æ›´æ–°ã€‘ï¼šæ–°å¢å®‰è£… tqdm
          pip install akshare pandas pandas-ta tqdm

      # 3. è¿è¡Œæ•°æ®åˆ†æè„šæœ¬ï¼Œå¹¶ç¦ç”¨è¿›åº¦æ¡
      - name: ğŸƒ Run Data Analysis and Disable TQDM
        env:
          # ç¦ç”¨ akshare å†…éƒ¨å¯èƒ½ä½¿ç”¨çš„è¿›åº¦æ¡ (è™½ç„¶æˆ‘ä»¬ç°åœ¨ä¸»è¦ä¾èµ– logging)
          TQDM_DISABLE: true
        run: |
          # ã€å…³é”®æ›´æ–°ã€‘ï¼šè¿è¡Œæœ€ç»ˆç”Ÿäº§ç¯å¢ƒè„šæœ¬
          python stock_analysis_ak_production.py

      # 4. æäº¤å’Œæ¨é€æ›´æ–°åçš„æ•°æ®æ–‡ä»¶
      - name: â¬†ï¸ Commit and Push Data
        run: |
          # é…ç½® Git ç”¨æˆ·ä¿¡æ¯
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„æ•°æ®æ–‡ä»¶æˆ–æ›´æ–°
          # åŒæ—¶æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„æ—¥å¿—æ–‡ä»¶ (stock_analysis.log)
          if git diff --exit-code --quiet index_data stock_analysis.log; then
            echo "No data or log changes to commit. Exiting."
          else
            # æ·»åŠ æ–°çš„æˆ–ä¿®æ”¹çš„æ–‡ä»¶
            git add index_data stock_analysis.log # ã€å…³é”®æ›´æ–°ã€‘ï¼šæ·»åŠ æ—¥å¿—æ–‡ä»¶
            
            # æäº¤æ›´æ”¹
            timestamp=$(date "+%Y-%m-%d %H:%M:%S")
            git commit -m "ğŸ¤– Data Update: Automated index analysis for ${timestamp} [skip ci]"
            
            # æ¨é€æ›´æ”¹åˆ° main åˆ†æ”¯
            git push
            echo "Data pushed successfully."
          fi
