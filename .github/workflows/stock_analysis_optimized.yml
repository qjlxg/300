name: Optimized Index Analysis (Incremental + Overlap)

on:
  schedule:
    - cron: '0 10 * * *'   # 每天 10:00（北京时间 18:00）
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  analyze_and_push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # ---------- 关键：先卸载 Tushare（若有），再装纯净 pytdx ----------
      - name: Install dependencies (clean pytdx)
        run: |
          python -m pip install --upgrade pip

          # 1. 彻底删除可能残留的 Tushare（含旧 pytdx）
          pip uninstall -y tushare 2>/dev/null || true

          # 2. 安装我们需要的库（固定 pytdx 版本）
          pip install \
            "pytdx==1.72" \
            pandas pandas-ta tqdm

      - name: Run analysis script
        env:
          TQDM_DISABLE: true
        run: |
          python stock_analysis_pytdx_production.py

      - name: Commit & push updated data
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

          if git diff --exit-code --quiet index_data stock_analysis.log; then
            echo "No changes to commit."
          else
            git add index_data stock_analysis.log
            timestamp=$(date "+%Y-%m-%d %H:%M:%S")
            git commit -m "Data Update: ${timestamp} [skip ci]"
            git push
            echo "Data pushed."
          fi
