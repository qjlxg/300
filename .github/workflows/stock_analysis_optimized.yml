name: Optimized Index Analysis (Incremental + Overlap)

on:
  schedule:
    - cron: '0 10 * * *'    # æ¯å¤© 10:00ï¼ˆåŒ—äº¬æ—¶é—´ 18:00ï¼‰
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  analyze_and_push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # ---------- å…³é”®ä¿®æ­£ï¼šå®‰è£… AkShare ä¾èµ– ----------
      - name: Install dependencies (AkShare) ğŸ› ï¸
        run: |
          python -m pip install --upgrade pip
          
          # 1. å½»åº•åˆ é™¤å¯èƒ½æ®‹ç•™çš„æ—§æ•°æ®æºåº“
          pip uninstall -y pytdx tushare baostock 2>/dev/null || true

          # 2. å®‰è£… AkShare å’Œå…¶ä»–æ ¸å¿ƒåº“
          pip install \
            "akshare" \
            pandas pandas-ta tqdm

      - name: Run analysis script
        env:
          TQDM_DISABLE: true
        run: |
          # ç¡®ä¿æ‚¨çš„ AkShare è„šæœ¬æ–‡ä»¶åä¸º stock_analysis_pytdx_production.py
          python stock_analysis_pytdx_production.py

      - name: Commit & push updated data ğŸš€
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

          # æ£€æŸ¥ index_data ç›®å½•æˆ– stock_analysis.log æ–‡ä»¶æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --exit-code --quiet index_data stock_analysis.log; then
            echo "No changes to commit."
          else
            git add index_data stock_analysis.log
            timestamp=$(date "+%Y-%m-%d %H:%M:%S")
            git commit -m "Data Update: ${timestamp} [skip ci]"
            git push
            echo "Data pushed."
          fi
