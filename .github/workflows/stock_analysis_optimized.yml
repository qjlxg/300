# .github/workflows/stock_analysis_optimized.yml

name: ğŸš€ ä¼˜åŒ–ç‰ˆæŒ‡æ•°åˆ†æ (å¢é‡ä¸é‡å )

# è§¦å‘æ¡ä»¶
on:
  workflow_dispatch:
  schedule:
    - cron: '00 10 * * *' # æ¯å¤©åŒ—äº¬æ—¶é—´ 18:00
  push:
    paths:
      - 'stock_analysis_ak_optimized.py' # è„šæœ¬æ–‡ä»¶åå·²æ›´æ–°
      - '.github/workflows/stock_analysis_optimized.yml'
      
defaults:
  run:
    shell: bash

jobs:
  analyze_and_push:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Shanghai

    steps:
      # 1. æ£€å‡ºä»£ç  (å¿…é¡»è¦æœ‰ fetch-depth: 0 æ‰èƒ½è¯»å–æ—§æ•°æ®å’Œæ¨é€)
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. è®¾ç½® Python ç¯å¢ƒ
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      # 3. å®‰è£…ä¾èµ– (akshare, pandas-ta)
      - name: âš™ï¸ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install akshare pandas pytz pandas-ta

      # 4. è¿è¡Œåˆ†æè„šæœ¬ (è„šæœ¬å†…éƒ¨å·²å®ç°å¤šçº¿ç¨‹å¹¶è¡Œä¸‹è½½å’Œå¢é‡æ›´æ–°)
      - name: ğŸƒ Run Optimized Analysis
        run: |
          python stock_analysis_ak_optimized.py

      # 5. é…ç½® Git
      - name: âš™ï¸ Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
      # 6. æ·»åŠ ã€æäº¤å’Œæ¨é€ç»“æœ
      - name: ğŸ“¤ Commit and Push Results
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "--- å‘ç°æ–°çš„åˆ†æç»“æœï¼Œæ­£åœ¨æäº¤ ---"
            
            # æ·»åŠ  index_data ç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶
            git add index_data
            
            # æäº¤æ›´æ”¹
            COMMIT_MESSAGE="ğŸ“Š Auto: Optimized index data update for $(date '+%Y-%m-%d %H:%M:%S')"
            git commit -m "$COMMIT_MESSAGE"
            
            # æ¨é€åˆ°ä»“åº“
            git push
            
            echo "âœ… æäº¤å’Œæ¨é€æˆåŠŸã€‚"
          else
            echo "--- æ–‡ä»¶å†…å®¹æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡æ¨é€ã€‚---"
          fi
