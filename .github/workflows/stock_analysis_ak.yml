# .github/workflows/stock_analysis_ak.yml

name: ğŸ“ˆ Stock Index Analysis and Push (Internal Parallel)

# æ§åˆ¶å·¥ä½œæµä½•æ—¶è¿è¡Œ
on:
  # 1. æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      reason:
        description: 'æ‰‹åŠ¨è¿è¡Œçš„åŸå›  (å¯é€‰)'
        required: false
        default: 'Manual run by user'

  # 2. å®šæ—¶æ¯å¤©è¿è¡Œ (æ¯å¤©åŒ—äº¬æ—¶é—´ 18:00 è¿è¡Œ)
  schedule:
    # 00 10 * * * æ˜¯ UTC æ—¶é—´ 10:00ï¼Œå¯¹åº”åŒ—äº¬æ—¶é—´ (UTC+8) 18:00
    - cron: '00 10 * * *'
    
  # 3. å½“è„šæœ¬æˆ–å·¥ä½œæµæ–‡ä»¶æœ¬èº«å‘ç”Ÿå˜åŒ–æ—¶è‡ªåŠ¨è¿è¡Œ
  push:
    paths:
      - 'stock_analysis_ak.py' 
      - '.github/workflows/stock_analysis_ak.yml'
      
defaults:
  run:
    shell: bash

jobs:
  analyze_and_push:
    runs-on: ubuntu-latest
    
    # å®šä¹‰ç¯å¢ƒæ—¶åŒºä¸ºä¸Šæµ·ï¼Œæ–¹ä¾¿æ—¥å¿—å’Œåç»­å‘½ä»¤ä½¿ç”¨
    env:
      TZ: Asia/Shanghai

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4
        # å¿…é¡»å¼€å¯ fetch-depth: 0 æ‰èƒ½åœ¨åç»­æ­¥éª¤ä¸­æ¨é€æ–°çš„æ–‡ä»¶å’Œç›®å½•
        with:
          fetch-depth: 0

      # 2. è®¾ç½® Python ç¯å¢ƒ
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      # 3. å®‰è£…ä¾èµ– (akshare, pandas, pytz)
      - name: âš™ï¸ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install akshare pandas pytz

      # 4. è¿è¡Œåˆ†æè„šæœ¬ (å†…éƒ¨å·²å®ç°å¤šçº¿ç¨‹å¹¶è¡Œä¸‹è½½å’Œåˆ†æ)
      - name: ğŸƒ Run Akshare Stock Analysis Script
        run: |
          # è„šæœ¬å†…éƒ¨ä½¿ç”¨å¤šçº¿ç¨‹å¹¶è¡Œè·å–æ‰€æœ‰æŒ‡æ•°çš„æ•°æ®å¹¶ä¿å­˜åˆ°å¹´æœˆç›®å½•
          python stock_analysis_ak.py

      # 5. é…ç½® Git (ç”¨äºæ¨é€)
      - name: âš™ï¸ Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
      # 6. æ·»åŠ ã€æäº¤å’Œæ¨é€ç»“æœ
      - name: ğŸ“¤ Commit and Push Results
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„æ–‡ä»¶æˆ–ç›®å½•è¢«åˆ›å»º (å³ç”Ÿæˆçš„ CSV æ–‡ä»¶)
          if [ -n "$(git status --porcelain)" ]; then
            echo "--- å‘ç°æ–°çš„åˆ†æç»“æœï¼Œæ­£åœ¨æäº¤ ---"
            
            # æ·»åŠ æ‰€æœ‰æ–°å¢å’Œä¿®æ”¹çš„æ–‡ä»¶ (å³ç”Ÿæˆçš„ å¹´/æœˆ/*.csv æ–‡ä»¶)
            git add .
            
            # æäº¤æ›´æ”¹
            COMMIT_MESSAGE="ğŸ“Š Auto: Update stock index analysis (Parallel run) for $(date '+%Y-%m-%d %H:%M:%S')"
            git commit -m "$COMMIT_MESSAGE"
            
            # æ¨é€åˆ°ä»“åº“
            git push
            
            echo "âœ… æäº¤å’Œæ¨é€æˆåŠŸã€‚"
          else
            echo "--- æ²¡æœ‰æ–°çš„åˆ†æç»“æœç”Ÿæˆæˆ–æ–‡ä»¶å†…å®¹æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡æ¨é€ã€‚---"
          fi
