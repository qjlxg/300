name: Stock Screener Workflow

on:
  # å½“ stock_screener_with_etf.py æˆ– workflow æ–‡ä»¶æœ¬èº«è¢« push æ—¶è§¦å‘
  push:
    paths:
      - 'stock_screener_with_etf.py'
      - '.github/workflows/screener.yml'
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  run-screener:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        # éœ€è¦è·å–å®Œæ•´çš„æäº¤å†å²æ‰èƒ½æ­£ç¡®æ¨é€åˆ°åˆ†æ”¯
        with:
          fetch-depth: 0

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies (æ–°å¢ tenacity) ğŸ“¦
        # å¢åŠ  tenacity ä»¥å¤„ç†è¿æ¥é‡è¯•
        run: pip install akshare pandas pandas_ta tenacity requests

      - name: Run screener script ğŸš€
        # è„šæœ¬å¦‚æœå› ç½‘ç»œé”™è¯¯å¤±è´¥ï¼Œä¼šè¢« tenacity è‡ªåŠ¨é‡è¯•
        run: python stock_screener_with_etf.py

      - name: Set Shanghai timezone and generate timestamp â°
        run: |
          # ç¡®ä¿æ—¶åŒºè®¾ç½®ä¸ºä¸Šæµ·/åŒ—äº¬æ—¶é—´
          export TZ='Asia/Shanghai'
          timestamp=$(date +%Y%m%d_%H%M%S)
          year_month=$(date +%Y/%m)
          echo "TIMESTAMP=$timestamp" >> $GITHUB_ENV
          echo "YEAR_MONTH=$year_month" >> $GITHUB_ENV

      - name: Move and rename result file ğŸ“
        # å°†ç»“æœæ–‡ä»¶ç§»åŠ¨åˆ°æŒ‰å¹´æœˆç»„ç»‡çš„æ–‡ä»¶å¤¹ä¸­
        run: |
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœè„šæœ¬å¤±è´¥æˆ–æ²¡æœ‰ç»“æœæ–‡ä»¶åˆ™è·³è¿‡
          if [ -f "screened_stocks_etf.csv" ]; then
            mkdir -p ${{ env.YEAR_MONTH }}
            mv screened_stocks_etf.csv ${{ env.YEAR_MONTH }}/screened_stocks_etf_${{ env.TIMESTAMP }}.csv
          else
            echo "æœªæ‰¾åˆ° screened_stocks_etf.csv æ–‡ä»¶ï¼Œå¯èƒ½ä»Šæ—¥æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ ‡çš„ã€‚"
          fi

      - name: Commit and push results ğŸ“¤
        # ä½¿ç”¨ git æäº¤å’Œæ¨é€ç»“æœ
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add .
          # ä½¿ç”¨ '|| true' æˆ– '|| echo ...' ç¡®ä¿å³ä½¿æ²¡æœ‰å˜åŒ–ï¼Œæ­¥éª¤ä¹Ÿä¸ä¼šå¤±è´¥
          git commit -m "Add screened stocks ETF results for ${{ env.TIMESTAMP }}" || echo "No changes to commit"
          git push
