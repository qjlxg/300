name: Stock Screener Workflow

on:
  push:
    paths:
      - 'stock_screener_with_etf.py'
      - '.github/workflows/screener.yml'
  workflow_dispatch:

jobs:
  run-screener:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        # éœ€è¦è·å–å®Œæ•´çš„æäº¤å†å²æ‰èƒ½æ­£ç¡®æ¨é€åˆ°åˆ†æ”¯
        with:
          fetch-depth: 0

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # ğŸš€ æ–°å¢ï¼šç¼“å­˜ Python ä¾èµ–ï¼ŒåŠ å¿«åç»­è¿è¡Œé€Ÿåº¦
      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          # ç¼“å­˜è·¯å¾„
          path: ${{ env.pythonLocation }}/lib/python*/site-packages
          # ç¼“å­˜é”®ï¼šåŸºäºæ“ä½œç³»ç»Ÿã€Pythonç‰ˆæœ¬å’Œè„šæœ¬æ–‡ä»¶å“ˆå¸Œ
          key: ${{ runner.os }}-python-${{ hashFiles('stock_screener_with_etf.py') }}
          restore-keys: |
            ${{ runner.os }}-python-

      - name: Install dependencies (æ–°å¢ tenacity, requests, futures) ğŸ“¦
        # ç¡®ä¿å®‰è£…äº†æ‰€æœ‰ä¾èµ–ï¼ŒåŒ…æ‹¬ç”¨äºåŠ é€Ÿçš„ concurrent.futures (è™½ç„¶å®ƒæ˜¯æ ‡å‡†åº“ï¼Œä½†ç¡®ä¿ requests å’Œ tenacity)
        run: pip install akshare pandas pandas_ta tenacity requests

      - name: Run screener script ğŸš€
        # è„šæœ¬å°†ä»¥å¤šçº¿ç¨‹æ–¹å¼è¿è¡Œ
        run: python stock_screener_with_etf.py

      - name: Set Shanghai timezone and generate timestamp â°
        run: |
          export TZ='Asia/Shanghai'
          timestamp=$(date +%Y%m%d_%H%M%S)
          year_month=$(date +%Y/%m)
          echo "TIMESTAMP=$timestamp" >> $GITHUB_ENV
          echo "YEAR_MONTH=$year_month" >> $GITHUB_ENV

      - name: Move and rename result file ğŸ“
        run: |
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœè„šæœ¬æˆåŠŸä½†æ²¡æœ‰ç»“æœæ–‡ä»¶ï¼ˆå³ä»Šæ—¥æ— ç¬¦åˆæ¡ä»¶æ ‡çš„ï¼‰åˆ™è·³è¿‡
          if [ -f "screened_stocks_etf.csv" ]; then
            mkdir -p ${{ env.YEAR_MONTH }}
            mv screened_stocks_etf.csv ${{ env.YEAR_MONTH }}/screened_stocks_etf_${{ env.TIMESTAMP }}.csv
          else
            echo "æœªæ‰¾åˆ° screened_stocks_etf.csv æ–‡ä»¶ï¼Œè·³è¿‡ç§»åŠ¨ã€‚"
          fi

      - name: Commit and push results ğŸ“¤
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add .
          # å¦‚æœæ²¡æœ‰å˜åŒ–ï¼Œä¸è¿›è¡Œ commitï¼Œå¹¶ç¡®ä¿å‘½ä»¤ä¸ä¼šå¤±è´¥
          git commit -m "Add screened stocks ETF results for ${{ env.TIMESTAMP }}" || echo "No changes to commit"
          git push
